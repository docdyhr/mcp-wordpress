name: ğŸ” Quality Assurance

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run quality checks daily at 6 AM UTC
    - cron: "0 6 * * *"

env:
  NODE_VERSION: "20"

jobs:
  # ğŸ§¹ Code Quality
  code-quality:
    name: ğŸ§¹ Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Needed for SonarCloud

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build Project
        run: npm run build

      - name: ğŸ§¹ ESLint Analysis
        run: |
          npm run lint -- --format json --output-file eslint-report.json || true
          npm run lint

      - name: ğŸ“Š Generate ESLint Report
        if: always()
        run: |
          echo "## ğŸ§¹ ESLint Report" > eslint-summary.md
          echo "" >> eslint-summary.md
          if [ -f eslint-report.json ]; then
            node -e "
              const report = JSON.parse(require('fs').readFileSync('eslint-report.json', 'utf8'));
              const totalErrors = report.reduce((sum, file) => sum + file.errorCount, 0);
              const totalWarnings = report.reduce((sum, file) => sum + file.warningCount, 0);
              console.log(\`- âŒ Errors: \${totalErrors}\`);
              console.log(\`- âš ï¸ Warnings: \${totalWarnings}\`);
              console.log(\`- ğŸ“ Files Checked: \${report.length}\`);
            " >> eslint-summary.md
          else
            echo "âœ… No linting issues found!" >> eslint-summary.md
          fi

      - name: ğŸ“¤ Upload ESLint Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: eslint-results
          path: |
            eslint-report.json
            eslint-summary.md

  # ğŸ”’ Security Analysis
  security-analysis:
    name: ğŸ”’ Security Analysis
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ”’ Security Audit
        run: |
          npm audit --audit-level moderate --json > security-audit.json || true
          npm audit --audit-level moderate || true

      - name: ğŸ” Dependency Vulnerabilities
        run: |
          npx audit-ci --config .audit-ci.json || echo "Security audit completed with findings"

      - name: ğŸ“Š Generate Security Report
        if: always()
        run: |
          echo "## ğŸ”’ Security Analysis Report" > security-summary.md
          echo "" >> security-summary.md
          if [ -f security-audit.json ]; then
            node -e "
              try {
                const audit = JSON.parse(require('fs').readFileSync('security-audit.json', 'utf8'));
                if (audit.metadata) {
                  console.log(\`- ğŸ”´ Critical: \${audit.metadata.vulnerabilities.critical || 0}\`);
                  console.log(\`- ğŸŸ  High: \${audit.metadata.vulnerabilities.high || 0}\`);
                  console.log(\`- ğŸŸ¡ Moderate: \${audit.metadata.vulnerabilities.moderate || 0}\`);
                  console.log(\`- ğŸ”µ Low: \${audit.metadata.vulnerabilities.low || 0}\`);
                  console.log(\`- â„¹ï¸ Info: \${audit.metadata.vulnerabilities.info || 0}\`);
                } else {
                  console.log('âœ… No security vulnerabilities found!');
                }
              } catch (e) {
                console.log('âœ… No security issues detected!');
              }
            " >> security-summary.md
          else
            echo "âœ… No security vulnerabilities found!" >> security-summary.md
          fi

      - name: ğŸ“¤ Upload Security Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-results
          path: |
            security-audit.json
            security-summary.md

  # ğŸ“Š Code Coverage
  coverage-analysis:
    name: ğŸ“Š Code Coverage
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build Project
        run: npm run build

      - name: ğŸ“Š Generate Coverage Report
        run: NODE_OPTIONS="--max-old-space-size=8192" npm run test:coverage
        env:
          CI: true

      - name: ğŸ“ˆ Coverage Summary
        run: |
          echo "## ğŸ“Š Code Coverage Report" > coverage-summary.md
          echo "" >> coverage-summary.md
          if [ -f coverage/coverage-summary.json ]; then
            node -e "
              const coverage = JSON.parse(require('fs').readFileSync('coverage/coverage-summary.json', 'utf8'));
              const total = coverage.total;
              console.log(\`- ğŸ“ Lines: \${total.lines.pct}%\`);
              console.log(\`- ğŸŒ² Branches: \${total.branches.pct}%\`);
              console.log(\`- ğŸ”§ Functions: \${total.functions.pct}%\`);
              console.log(\`- ğŸ“„ Statements: \${total.statements.pct}%\`);
            " >> coverage-summary.md
          fi

      - name: ğŸ“¤ Upload Coverage Reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage/
            coverage-summary.md

      - name: ğŸ“ˆ Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella

  # ğŸ§ª Performance Testing
  performance-testing:
    name: ğŸ§ª Performance Testing
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build Project
        run: npm run build

      - name: âš¡ Performance Benchmarks
        run: |
          echo "## âš¡ Performance Benchmarks" > performance-report.md
          echo "" >> performance-report.md

          # Startup time test
          echo "### ğŸš€ Startup Performance:" >> performance-report.md
          START_TIME=$(date +%s%3N)
          timeout 30s npm run health > /dev/null 2>&1 || true
          END_TIME=$(date +%s%3N)
          DURATION=$((END_TIME - START_TIME))
          echo "- Health check duration: ${DURATION}ms" >> performance-report.md

          # Memory usage test
          echo "" >> performance-report.md
          echo "### ğŸ’¾ Memory Usage:" >> performance-report.md
          node -e "
            const used = process.memoryUsage();
            console.log(\`- RSS: \${Math.round(used.rss / 1024 / 1024 * 100) / 100} MB\`);
            console.log(\`- Heap Used: \${Math.round(used.heapUsed / 1024 / 1024 * 100) / 100} MB\`);
            console.log(\`- Heap Total: \${Math.round(used.heapTotal / 1024 / 1024 * 100) / 100} MB\`);
            console.log(\`- External: \${Math.round(used.external / 1024 / 1024 * 100) / 100} MB\`);
          " >> performance-report.md

      - name: ğŸ“¤ Upload Performance Report
        uses: actions/upload-artifact@v4
        with:
          name: performance-report
          path: performance-report.md

  # ğŸ“ Documentation Quality
  documentation-check:
    name: ğŸ“ Documentation Quality
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“ Check Markdown Files
        run: |
          # Install markdown linter
          npm install -g markdownlint-cli

          # Check markdown files
          markdownlint "**/*.md" --ignore node_modules > markdown-issues.txt || true

          echo "## ğŸ“ Documentation Quality Report" > docs-quality.md
          echo "" >> docs-quality.md

          if [ -s markdown-issues.txt ]; then
            echo "### âš ï¸ Markdown Issues Found:" >> docs-quality.md
            echo '```' >> docs-quality.md
            cat markdown-issues.txt >> docs-quality.md
            echo '```' >> docs-quality.md
          else
            echo "âœ… All markdown files pass quality checks!" >> docs-quality.md
          fi

      - name: ğŸ”— Check Documentation Links
        run: |
          # Install link checker
          npm install -g markdown-link-check

          echo "" >> docs-quality.md
          echo "### ğŸ”— Link Check Results:" >> docs-quality.md

          # Check links in all markdown files
          find . -name "*.md" -not -path "./node_modules/*" | while read file; do
            echo "Checking links in: $file"
            if markdown-link-check "$file" --quiet; then
              echo "- âœ… $file: All links working" >> docs-quality.md
            else
              echo "- âŒ $file: Some links broken" >> docs-quality.md
            fi
          done

      - name: ğŸ“¤ Upload Documentation Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: documentation-quality
          path: |
            docs-quality.md
            markdown-issues.txt

  # ğŸ“Š Quality Gates
  quality-gates:
    name: ğŸ“Š Quality Gates
    runs-on: ubuntu-latest
    needs: [code-quality, security-analysis, coverage-analysis, performance-testing, documentation-check]
    if: always()
    steps:
      - name: ğŸ“Š Evaluate Quality Gates
        run: |
          echo "## ğŸ“Š Quality Gates Evaluation" > quality-gates.md
          echo "" >> quality-gates.md

          echo "### ğŸ¯ Quality Gate Results:" >> quality-gates.md
          echo "- ğŸ§¹ Code Quality: ${{ needs.code-quality.result }}" >> quality-gates.md
          echo "- ğŸ”’ Security Analysis: ${{ needs.security-analysis.result }}" >> quality-gates.md
          echo "- ğŸ“Š Coverage Analysis: ${{ needs.coverage-analysis.result }}" >> quality-gates.md
          echo "- ğŸ§ª Performance Testing: ${{ needs.performance-testing.result }}" >> quality-gates.md
          echo "- ğŸ“ Documentation Check: ${{ needs.documentation-check.result }}" >> quality-gates.md
          echo "" >> quality-gates.md

          # Calculate overall quality score
          PASSED=0
          TOTAL=5

          [ "${{ needs.code-quality.result }}" == "success" ] && PASSED=$((PASSED + 1))
          [ "${{ needs.security-analysis.result }}" == "success" ] && PASSED=$((PASSED + 1))
          [ "${{ needs.coverage-analysis.result }}" == "success" ] && PASSED=$((PASSED + 1))
          [ "${{ needs.performance-testing.result }}" == "success" ] && PASSED=$((PASSED + 1))
          [ "${{ needs.documentation-check.result }}" == "success" ] && PASSED=$((PASSED + 1))

          SCORE=$((PASSED * 100 / TOTAL))
          echo "### ğŸ“ˆ Overall Quality Score: ${SCORE}%" >> quality-gates.md
          echo "" >> quality-gates.md

          if [ $SCORE -ge 80 ]; then
            echo "âœ… **Quality gates PASSED** - Code meets quality standards!" >> quality-gates.md
            echo "QUALITY_GATE_PASSED=true" >> $GITHUB_ENV
          else
            echo "âŒ **Quality gates FAILED** - Code needs improvement!" >> quality-gates.md
            echo "QUALITY_GATE_PASSED=false" >> $GITHUB_ENV
          fi

      - name: ğŸ“¤ Upload Quality Gates Report
        uses: actions/upload-artifact@v4
        with:
          name: quality-gates-report
          path: quality-gates.md

      - name: âŒ Fail on Quality Gate Failure
        if: env.QUALITY_GATE_PASSED == 'false'
        run: |
          echo "âŒ Quality gates failed - see quality-gates-report for details"
          exit 1

      - name: âœ… Quality Gates Passed
        if: env.QUALITY_GATE_PASSED == 'true'
        run: echo "âœ… All quality gates passed successfully!"
